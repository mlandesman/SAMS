/**
 * AVII Water Bills Adjustment Script
 * 
 * Purpose: Adjust Q1 water bill data to match Sheets statements exactly
 * 
 * Adjustments:
 * 1. Unit 101: Remove July charge (350‚Üí0), reduce August (300‚Üí60.27) due to June credit
 * 2. Unit 103: Add 400 pesos lavado (4 car washes not imported)
 * 3. Unit 106: Fix June (550‚Üí1029.47), July (550‚Üí310.27) - reading corrections
 * 
 * Also:
 * - Delete Q2 water bill (will be regenerated by SAMS)
 * - Convert October payments for 102, 103 to credits
 * 
 * Usage: 
 *   DRY RUN: node backend/scripts/adjust-avii-water-bills.js
 *   EXECUTE: node backend/scripts/adjust-avii-water-bills.js --execute
 */

import { initializeApp, cert } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';
import fs from 'fs';
import path from 'path';

// Initialize Firebase
const serviceAccountPath = path.resolve('./backend/serviceAccountKey.json');
const serviceAccount = JSON.parse(fs.readFileSync(serviceAccountPath, 'utf8'));

initializeApp({
  credential: cert(serviceAccount)
});

const db = getFirestore();
const CLIENT_ID = 'AVII';
const DRY_RUN = !process.argv.includes('--execute');

console.log('‚ïê'.repeat(70));
console.log('  AVII WATER BILLS ADJUSTMENT SCRIPT');
console.log('‚ïê'.repeat(70));
console.log(`Mode: ${DRY_RUN ? 'üîç DRY RUN (no changes)' : '‚ö° EXECUTE (making changes)'}`);
console.log('');

async function getQ1Bill() {
  const doc = await db.collection('clients').doc(CLIENT_ID)
    .collection('projects').doc('waterBills')
    .collection('bills').doc('2026-Q1').get();
  return doc.exists ? doc.data() : null;
}

async function updateQ1Bill(updates) {
  if (DRY_RUN) {
    console.log('  [DRY RUN] Would update Q1 bill');
    return;
  }
  await db.collection('clients').doc(CLIENT_ID)
    .collection('projects').doc('waterBills')
    .collection('bills').doc('2026-Q1').update(updates);
  console.log('  ‚úÖ Q1 bill updated');
}

async function deleteQ2Bill() {
  const docRef = db.collection('clients').doc(CLIENT_ID)
    .collection('projects').doc('waterBills')
    .collection('bills').doc('2026-Q2');
  
  const doc = await docRef.get();
  if (!doc.exists) {
    console.log('  Q2 bill does not exist, nothing to delete');
    return;
  }
  
  if (DRY_RUN) {
    console.log('  [DRY RUN] Would delete Q2 bill');
    return;
  }
  
  await docRef.delete();
  console.log('  ‚úÖ Q2 bill deleted');
}

async function adjustUnit101(billData) {
  console.log('\n--- Unit 101 Adjustments ---');
  const unit = billData.bills.units['101'];
  
  if (!unit) {
    console.log('  ‚ö†Ô∏è Unit 101 not found in Q1 bill');
    return null;
  }
  
  console.log('  Current:');
  console.log(`    June: ${unit.monthlyBreakdown[0].waterCharge / 100} pesos`);
  console.log(`    July: ${unit.monthlyBreakdown[1].waterCharge / 100} pesos`);
  console.log(`    August: ${unit.monthlyBreakdown[2].waterCharge / 100} pesos`);
  console.log(`    Total waterCharge: ${unit.waterCharge / 100} pesos`);
  
  // Calculate new values
  const juneCharge = 90000; // 900 pesos - unchanged
  const julyCharge = 0;     // Was 35000 (350 pesos), now 0
  const augCharge = 6027;   // Was 30000 (300 pesos), now 60.27 pesos (after 239.73 credit)
  
  const newWaterCharge = juneCharge + julyCharge + augCharge; // 96027 centavos = 960.27 pesos
  const newCurrentCharge = newWaterCharge + (unit.importedLavadoCharge || 0);
  const newTotalAmount = newCurrentCharge + (unit.penaltyAmount || 0);
  
  console.log('  New:');
  console.log(`    June: ${juneCharge / 100} pesos (unchanged)`);
  console.log(`    July: ${julyCharge / 100} pesos (was 350, removed)`);
  console.log(`    August: ${augCharge / 100} pesos (was 300, reduced by 239.73 credit)`);
  console.log(`    Total waterCharge: ${newWaterCharge / 100} pesos`);
  
  return {
    'bills.units.101.monthlyBreakdown.1.waterCharge': julyCharge,
    'bills.units.101.monthlyBreakdown.1.totalAmount': julyCharge,
    'bills.units.101.monthlyBreakdown.1.consumption': 0,
    'bills.units.101.monthlyBreakdown.2.waterCharge': augCharge,
    'bills.units.101.monthlyBreakdown.2.totalAmount': augCharge,
    'bills.units.101.waterCharge': newWaterCharge,
    'bills.units.101.currentCharge': newCurrentCharge,
    'bills.units.101.totalAmount': newTotalAmount,
    'bills.units.101.totalConsumption': unit.monthlyBreakdown[0].consumption + 0 + unit.monthlyBreakdown[2].consumption,
  };
}

async function adjustUnit103(billData) {
  console.log('\n--- Unit 103 Adjustments ---');
  console.log('  No adjustments needed - lavado charges discontinued');
  return null;
}

async function adjustUnit106(billData) {
  console.log('\n--- Unit 106 Adjustments ---');
  const unit = billData.bills.units['106'];
  
  if (!unit) {
    console.log('  ‚ö†Ô∏è Unit 106 not found in Q1 bill');
    return null;
  }
  
  console.log('  Current:');
  console.log(`    June: ${unit.monthlyBreakdown[0].waterCharge / 100} pesos`);
  console.log(`    July: ${unit.monthlyBreakdown[1].waterCharge / 100} pesos`);
  console.log(`    August: ${unit.monthlyBreakdown[2].waterCharge / 100} pesos`);
  console.log(`    Total waterCharge: ${unit.waterCharge / 100} pesos`);
  
  // Fix values to match Sheets
  const juneCharge = 102947; // 1029.47 pesos (was 55000 = 550 pesos)
  const julyCharge = 31027;  // 310.27 pesos (was 55000 = 550 pesos)
  const augCharge = 45000;   // 450 pesos - unchanged
  
  const newWaterCharge = juneCharge + julyCharge + augCharge; // 178974 centavos = 1789.74 pesos
  const newCurrentCharge = newWaterCharge + (unit.importedLavadoCharge || 0);
  const newTotalAmount = newCurrentCharge + (unit.penaltyAmount || 0);
  
  // Calculate new consumption (at 50 pesos per m¬≥)
  const juneConsumption = Math.round(juneCharge / 5000); // ~21 m¬≥
  const julyConsumption = Math.round(julyCharge / 5000); // ~6 m¬≥
  
  console.log('  New:');
  console.log(`    June: ${juneCharge / 100} pesos (was 550)`);
  console.log(`    July: ${julyCharge / 100} pesos (was 550)`);
  console.log(`    August: ${augCharge / 100} pesos (unchanged)`);
  console.log(`    Total waterCharge: ${newWaterCharge / 100} pesos`);
  
  return {
    'bills.units.106.monthlyBreakdown.0.waterCharge': juneCharge,
    'bills.units.106.monthlyBreakdown.0.totalAmount': juneCharge,
    'bills.units.106.monthlyBreakdown.0.consumption': juneConsumption,
    'bills.units.106.monthlyBreakdown.1.waterCharge': julyCharge,
    'bills.units.106.monthlyBreakdown.1.totalAmount': julyCharge,
    'bills.units.106.monthlyBreakdown.1.consumption': julyConsumption,
    'bills.units.106.waterCharge': newWaterCharge,
    'bills.units.106.currentCharge': newCurrentCharge,
    'bills.units.106.totalAmount': newTotalAmount,
    'bills.units.106.totalConsumption': juneConsumption + julyConsumption + unit.monthlyBreakdown[2].consumption,
  };
}

async function main() {
  try {
    // Get current Q1 bill
    console.log('Loading Q1 water bill...');
    const q1Bill = await getQ1Bill();
    
    if (!q1Bill) {
      console.log('‚ùå Q1 bill not found!');
      process.exit(1);
    }
    
    console.log('‚úÖ Q1 bill loaded');
    console.log(`   Units: ${Object.keys(q1Bill.bills?.units || {}).join(', ')}`);
    
    // Collect all updates
    const allUpdates = {};
    
    // Unit 101
    const updates101 = await adjustUnit101(q1Bill);
    if (updates101) Object.assign(allUpdates, updates101);
    
    // Unit 103
    const updates103 = await adjustUnit103(q1Bill);
    if (updates103) Object.assign(allUpdates, updates103);
    
    // Unit 106
    const updates106 = await adjustUnit106(q1Bill);
    if (updates106) Object.assign(allUpdates, updates106);
    
    // Apply Q1 updates
    if (Object.keys(allUpdates).length > 0) {
      console.log('\n--- Applying Q1 Updates ---');
      console.log(`  ${Object.keys(allUpdates).length} field updates`);
      await updateQ1Bill(allUpdates);
    }
    
    // Delete Q2 bill
    console.log('\n--- Q2 Bill Deletion ---');
    await deleteQ2Bill();
    
    // Summary
    console.log('\n' + '‚ïê'.repeat(70));
    console.log('  SUMMARY');
    console.log('‚ïê'.repeat(70));
    console.log('');
    console.log('Q1 Adjustments:');
    console.log('  ‚úì Unit 101: July removed (350‚Üí0), August reduced (300‚Üí60.27)');
    console.log('  - Unit 103: No changes (lavado discontinued)');
    console.log('  ‚úì Unit 106: June/July fixed (550‚Üí1029.47, 550‚Üí310.27)');
    console.log('');
    console.log('Q2 Bill:');
    console.log('  ‚úì Deleted (will be regenerated by SAMS)');
    console.log('');
    
    if (DRY_RUN) {
      console.log('üîç DRY RUN COMPLETE - No changes made');
      console.log('   Run with --execute to apply changes');
    } else {
      console.log('‚ö° CHANGES APPLIED');
      console.log('');
      console.log('Next steps:');
      console.log('  1. Run firestore-to-json.sh to export Q1 bill');
      console.log('  2. Verify with dry-run comparison script');
      console.log('  3. Handle October payment credits for 102, 103');
    }
    console.log('');
    
  } catch (error) {
    console.error('Error:', error);
    process.exit(1);
  }
}

main();
